"use strict";
var fs = require('fs'),
    crypto = require("crypto"),
    through = require("through2"),
    path = require("path"),
    File = require("gulp-util").File;

var map = {};

module.exports = function(opts) {
  opts = typeof(opts) === "string" ? {target: opts} : (opts || {});
  opts.target = opts.target || "hashMap.json";
  opts.algorithm = opts.algorithm || "md5";
  opts.length = opts.length || 8;
  opts.flatten = opts.flatten === false ? opts.flatten : true;
  opts.cwd = opts.cwd || process.cwd();

  if (!map.hasOwnProperty(opts.target)) {
    map[opts.target] = {};
  }

  var stream = through.obj(function(file, enc, done) {
    this.push(file);

    if (file.isNull()) return;

    var contents = file.isBuffer() ? file.contents : new Buffer();
    if (file.isStream()) file.contents.pipe(contents);

    var digest = crypto.createHash(opts.algorithm);
    digest.update(file.contents, 'utf8');
    var tag = digest.digest("hex");
    var prefix = opts.length ? tag.substr(0, opts.length) : tag;
    var name = opts.flatten ? path.basename(file.path) : path.relative(opts.cwd, file.path);
    var real_name = [prefix, name].join('.');
    map[opts.target][name] = prefix;
    var real_path = path.resolve(path.dirname(file.path), real_name);

    console.log(file.path);
    console.log(real_path);
    //fs.renameSync(file.path, real_path);

    done();
  }, function(done) {
    var file = new File({
      cwd: opts.cwd,
      base: opts.cwd,
      path: path.join(opts.cwd, opts.target),
      contents: new Buffer(JSON.stringify(map[opts.target]))
    });

    this.push(file);
    done();
  });

  return stream;
};
